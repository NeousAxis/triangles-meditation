<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triangle Meditation Network</title>
    
    <!-- Firebase SDK (chargement facultatif) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <script>
      // Initialisation optionnelle de Firebase
      let database = null;
      try {
        // Configuration Firebase pour votre application
        const firebaseConfig = {
          apiKey: "AIzaSyBaMcVHdo2yWYCO0K19iLQkWg1W3_zxy_8",
          authDomain: "triangles-meditation.firebaseapp.com",
          databaseURL: "https://triangles-meditation-default-rtdb.firebaseio.com",
          projectId: "triangles-meditation",
          storageBucket: "triangles-meditation.appspot.com",
          messagingSenderId: "501789370541",
          appId: "1:501789370541:web:11dd620095e401503a7e24",
          measurementId: "G-QPWKZZN6T1"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        console.log("Firebase initialisé avec succès");
      } catch (error) {
        console.error("Erreur d'initialisation Firebase:", error);
        // Continue sans Firebase
      }
    </script>
    
    <!-- Reste de vos bibliothèques/styles inchangés -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://unpkg.com/marked@4.0.0/marked.min.js"></script>
    <!-- Styles inchangés -->
    <style>
        /* Vos styles existants */
    </style>
</head>
<body>
    <!-- Reste du HTML inchangé -->

    <script>
        // Fonction de jointure au réseau hybride (local + Firebase si disponible)
        async function joinNetwork() {
            const userName = document.getElementById('user-name').value;
            const continent = document.getElementById('user-continent').value;
            const country = document.getElementById('user-country').value;
            const city = document.getElementById('user-city').value;
            
            // Validations
            if (!userName) {
                alert(getText('enterName'));
                return;
            }
            
            if (!continent) {
                alert(getText('selectContinent'));
                return;
            }
            
            if (!country) {
                alert(getText('selectCountry'));
                return;
            }
            
            if (!city) {
                alert(getText('enterCity'));
                return;
            }
            
            // Show loading state
            const joinButton = document.getElementById('join-network');
            const joinText = document.getElementById('join-text');
            const originalText = joinText.textContent;
            
            joinButton.disabled = true;
            joinText.innerHTML = `<div class="loading-spinner"></div> ${originalText}`;
            
            try {
                // Get coordinates for the city
                const coordinates = await getCityCoordinates(city, country);
                
                // Générer un ID unique
                const userId = 'user-' + Date.now();
                
                // Create user profile
                const userProfile = {
                    id: userId,
                    name: userName,
                    continent: continent,
                    country: country,
                    city: city,
                    coordinates: coordinates,
                    language: window.appData.currentLanguage,
                    joinedAt: Date.now(),
                    expiresAt: Date.now() + (20 * 60 * 1000) // 20 minutes
                };
                
                // Sauvegarder localement (fonctionne toujours)
                window.appData.userProfile = userProfile;
                window.appData.participants.push(userProfile);
                
                // Save to localStorage if available
                if (window.localStorage) {
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                }
                
                // Tenter la synchronisation Firebase (ne bloque pas si ça échoue)
                if (database) {
                    try {
                        database.ref('participants/' + userId).set(userProfile)
                            .then(() => {
                                console.log("Synchronisé avec Firebase");
                                database.ref('participants/' + userId).onDisconnect().remove();
                            })
                            .catch(err => {
                                console.warn("Échec de synchronisation avec Firebase:", err);
                            });
                    } catch (firebaseError) {
                        console.warn("Erreur Firebase:", firebaseError);
                        // Continue sans Firebase
                    }
                }
                
                // Form triangles (fonctionne localement)
                formTriangles();
                
                // Hide registration form and show status panel
                document.getElementById('registration-form').classList.add('hidden');
                document.getElementById('status-panel').classList.remove('hidden');
                
                // Update participant info
                document.getElementById('participant-info').textContent = 
                    `${getText('yourCoordinates')}: [${coordinates[0].toFixed(2)}, ${coordinates[1].toFixed(2)}]`;
                
                // Update triangle status
                const userTriangle = findUserTriangle();
                if (userTriangle) {
                    document.getElementById('triangle-status').textContent = 
                        `You are part of triangle #${userTriangle.id}`;
                } else {
                    document.getElementById('triangle-status').textContent = getText('waitingForTriangle');
                }
                
                // Update time remaining message
                document.getElementById('time-remaining').textContent = getText('timeRemaining');
                
                // Start the countdown timer for the position
                startPositionTimer();
                
                // Update statistics
                updateStatisticsDisplay();
                
            } catch (error) {
                console.error("Error joining network:", error);
                
                joinButton.disabled = false;
                joinText.textContent = originalText;
                
                alert(getText('locationError'));
            }
        }
        
        // Fonction modifiée pour quitter le réseau
        function leaveNetwork() {
            if (!window.appData.userProfile) return;
            
            // Supprimer de Firebase (si disponible)
            if (database) {
                try {
                    database.ref('participants/' + window.appData.userProfile.id).remove()
                        .catch(err => console.warn("Erreur lors de la suppression Firebase:", err));
                } catch (error) {
                    console.warn("Erreur Firebase:", error);
                }
            }
            
            // Supprimer localement (fonctionne toujours)
            const index = window.appData.participants.findIndex(p => p.id === window.appData.userProfile.id);
            if (index !== -1) {
                window.appData.participants.splice(index, 1);
            }
            
            // Clear user profile
            window.appData.userProfile = null;
            
            // Clear from localStorage if available
            if (window.localStorage) {
                localStorage.removeItem('userProfile');
            }
            
            // Re-form triangles
            formTriangles();
            
            // Reset UI
            document.getElementById('status-panel').classList.add('hidden');
            document.getElementById('registration-form').classList.remove('hidden');
            
            // Update statistics
            updateStatisticsDisplay();
        }
        
        // Remplacer l'initialisation de listenForParticipants par une version qui ne bloque pas
        document.addEventListener('DOMContentLoaded', function() {
            // Votre code d'initialisation existant...
            
            // Tentative d'écoute Firebase (facultative)
            if (database) {
                try {
                    listenForParticipantsFirebase();
                } catch (error) {
                    console.warn("Impossible d'écouter les participants Firebase:", error);
                    // Continue sans Firebase
                }
            }
        });
        
        // Fonction d'écoute Firebase (facultative)
        function listenForParticipantsFirebase() {
            database.ref('participants').on('value', (snapshot) => {
                try {
                    // Conserver l'utilisateur actuel
                    const currentUser = window.appData.userProfile;
                    
                    // Récupérer les participants depuis Firebase
                    const firebaseParticipants = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const participant = childSnapshot.val();
                            if (participant.expiresAt > Date.now()) {
                                firebaseParticipants.push(participant);
                            }
                        });
                    }
                    
                    // Mise à jour locale uniquement si des participants ont été trouvés
                    if (firebaseParticipants.length > 0) {
                        // Remplacer participants tout en gardant l'utilisateur actuel
                        window.appData.participants = firebaseParticipants;
                        
                        // S'assurer que l'utilisateur actuel est inclus
                        if (currentUser && !window.appData.participants.some(p => p.id === currentUser.id)) {
                            window.appData.participants.push(currentUser);
                        }
                        
                        // Former des triangles et mettre à jour l'affichage
                        formTriangles();
                        updateTriangles();
                        updateStatisticsDisplay();
                    }
                } catch (error) {
                    console.warn("Erreur lors de la synchronisation des participants:", error);
                    // Continue avec les données locales
                }
            });
        }
        
        // Autres fonctions inchangées...
    </script>
</body>
</html>
