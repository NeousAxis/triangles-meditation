<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Méditation en triangle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  />

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; position:absolute; top:0; left:0; }
    #controls {
      position:absolute; top:1rem; right:1rem; z-index:1000;
      background:rgba(255,255,255,0.9); padding:1rem;
      border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.3);
      font-family:sans-serif; display:flex; flex-direction:column; gap:0.5rem;
    }
    .group-list { display:flex; flex-wrap:wrap; gap:0.3rem; margin-bottom:0.5rem; }
    .group-list button,
    #controls button,
    #controls select { padding:0.4rem 0.8rem; font-size:0.9rem; }
    #controls label { display:flex; align-items:center; gap:0.5rem; }
  </style>
</head>
<body>
  <!-- Carte -->
  <div id="map"></div>

  <!-- Contrôles -->
  <div id="controls">
    <span id="lbl-triangle">Triangle :</span>
    <div id="groupList" class="group-list"></div>
    <button id="newBtn">Nouveau</button>
    <button id="addBtn">Je médite !</button>
    <button id="simulateBtn">Simuler</button>
    <label>
      <span id="lbl-lang">Langue :</span>
      <select id="langSelect"></select>
    </label>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- Firebase SDKs compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) CONFIG FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyBaMcVHdo2yWYCO0K19iLQkWg1W3_zxy_8",
      authDomain: "triangles-meditation.firebaseapp.com",
      projectId: "triangles-meditation",
      storageBucket: "triangles-meditation.appspot.com",
      messagingSenderId: "501789370541",
      appId: "1:501789370541:web:11dd620095e401503a7e24",
      measurementId: "G-QPWKZZN6T1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2) INIT LEAFLET
    const map = L.map('map').setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap contributors'
    }).addTo(map);
    delete L.Icon.Default.prototype._getIconUrl;
    L.Icon.Default.mergeOptions({
      iconRetinaUrl:'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png',
      iconUrl:'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
      shadowUrl:'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png'
    });

    // 3) ÉTAT & I18N
    let markers = [], selected = '', lang = 'fr';
    const i18n = {
      fr:{triangle:'Triangle', add:'Je médite !', simulate:'Simuler', new:'Nouveau', lang:'Langue', popup:'Triangle', alertAdd:'Point ajouté : '},
      en:{triangle:'Triangle', add:'I meditate!', simulate:'Simulate', new:'New', lang:'Language', popup:'Triangle', alertAdd:'Added point: '}
    };

    // 4) DOM REFS
    const groupList   = document.getElementById('groupList');
    const newBtn      = document.getElementById('newBtn');
    const addBtn      = document.getElementById('addBtn');
    const simBtn      = document.getElementById('simulateBtn');
    const langSelect  = document.getElementById('langSelect');
    const lblTriangle = document.getElementById('lbl-triangle');
    const lblLang     = document.getElementById('lbl-lang');

    // 5) POPULER LANGUES
    Object.keys(i18n).forEach(code => {
      const opt = document.createElement('option');
      opt.value = code; opt.textContent = code.toUpperCase();
      langSelect.appendChild(opt);
    });
    langSelect.value = lang;

    // 6) FONCTIONS DE RENDER
    function translateUI() {
      lblTriangle.textContent = i18n[lang].triangle + ' :';
      newBtn.textContent      = i18n[lang].new;
      addBtn.textContent      = i18n[lang].add;
      simBtn.textContent      = i18n[lang].simulate;
      lblLang.textContent     = i18n[lang].lang + ' :';
    }

    function renderMarkers() {
      map.eachLayer(l => {
        if (l instanceof L.Marker || l instanceof L.CircleMarker) {
          map.removeLayer(l);
        }
      });
      markers.forEach(m => {
        const isSel = m.triangle_id === selected;
        const mk = isSel
          ? L.circleMarker([m.lat,m.lng],{radius:8,color:'#f00',fillOpacity:0.6})
          : L.marker([m.lat,m.lng]);
        mk.bindPopup((isSel?'▶ ':'') + i18n[lang].popup + m.triangle_id);
        mk.addTo(map);
      });
    }

    // 7) TRIANGLES STRUCTURÉS
    let triangleLayers = {};
    function renderTriangles() {
      // supprime anciens
      Object.values(triangleLayers).forEach(t=>map.removeLayer(t));
      triangleLayers = {};

      // regroupe
      const groups = markers.reduce((acc,m) => {
        (acc[m.triangle_id]||(acc[m.triangle_id]=[])).push([m.lat,m.lng]);
        return acc;
      }, {});

      // dessine
      Object.entries(groups).forEach(([tid, pts]) => {
        if (pts.length === 3) {
          // triangle complet
          const poly = L.polygon(pts, {
            color: '#006', weight: 2, fillColor: '#06f', fillOpacity: 0.2
          }).addTo(map);
          triangleLayers[tid] = poly;
        } else if (pts.length === 2) {
          // ligne pointillée
          const line = L.polyline(pts, {
            color: '#a00', weight: 2, dashArray: '5,5'
          }).addTo(map);
          triangleLayers[tid] = line;
        }
        // 1 seul point → reste marqueur
      });
    }

    // 8) RAFRAÎCHIR TOUT
    function updateAll() {
      translateUI();
      renderGroups();
      renderMarkers();
      renderTriangles();
    }

    function renderGroups() {
      groupList.innerHTML = '';
      newBtn.onclick = () => { selected = ''; updateAll(); };
      const counts = markers.reduce((a,m) => {
        a[m.triangle_id] = (a[m.triangle_id]||0)+1; return a;
      }, {});
      Object.entries(counts).forEach(([id,c]) => {
        const b = document.createElement('button');
        b.textContent = `${id} (${c})`;
        b.onclick = () => { selected = id; updateAll(); };
        if (id === selected) b.style.background = '#ddd';
        groupList.appendChild(b);
      });
    }

    // 9) FIRESTORE REALTIME
    db.collection('markers').orderBy('created_at')
      .onSnapshot(snap => {
        markers = snap.docs.map(d => d.data());
        updateAll();
      });

    // 10) AJOUTER POINT
    addBtn.onclick = () => navigator.geolocation.getCurrentPosition(({coords}) => {
      const tri = selected || crypto.randomUUID().slice(0,8);
      db.collection('markers').add({
        triangle_id: tri,
        lat: coords.latitude,
        lng: coords.longitude,
        created_at: Date.now()
      });
      alert(i18n[lang].alertAdd + tri);
    });

    // 11) SIMULER
    simBtn.onclick = async () => {
      const batch = db.batch();
      (await db.collection('markers').get()).docs.forEach(d => batch.delete(d.ref));
      await batch.commit();
      for (let t=0; t<10; t++) {
        const id = crypto.randomUUID().slice(0,6);
        const lat0 = Math.random()*180-90, lng0 = Math.random()*360-180;
        for (let i=0; i<3; i++) {
          db.collection('markers').add({
            triangle_id: id,
            lat: lat0 + (Math.random()-0.5)*5,
            lng: lng0 + (Math.random()-0.5)*5,
            created_at: Date.now()
          });
        }
      }
    };

    // 12) LANGUE
    langSelect.onchange = e => { lang = e.target.value; updateAll(); };

    // Init
    updateAll();
  });
  </script>
</body>
</html>
