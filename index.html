<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Triangle Meditation Network</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { primary: '#5D5CDE' } } } };
  </script>
  <!-- D3, TopoJSON, Delaunay -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script src="https://unpkg.com/d3-delaunay@6"></script>
  <style>
    .triangle-path { stroke-dasharray:10; animation:dash 3s linear infinite; }
    @keyframes dash { to { stroke-dashoffset:30; } }
    .triangle-point { animation:pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:.7;transform:scale(.9);}50%{opacity:1;transform:scale(1.2);} }
    .user-point { stroke:#fff; stroke-width:2px; animation:userPulse 2s infinite; }
    @keyframes userPulse { 0%,100%{opacity:.8;transform:scale(1);}50%{opacity:1;transform:scale(1.3);} }
  </style>
</head>
<body class="bg-white text-gray-800 font-sans min-h-screen flex flex-col">
  <header class="bg-primary text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
      <h1 id="app-title" class="text-2xl">Triangle Meditation Network</h1>
      <select id="lang" class="bg-white text-gray-800 p-1 rounded">
        <option value="en">English</option><option value="fr">Français</option>
        <option value="es">Español</option><option value="de">Deutsch</option>
        <option value="it">Italiano</option><option value="ru">Русский</option>
        <option value="zh">中文</option><option value="ar">العربية</option>
        <option value="hi">हिन्दी</option>
      </select>
    </div>
  </header>
  <main class="flex-grow container mx-auto p-4 flex flex-col md:flex-row gap-6">
    <!-- Map -->
    <section class="w-full md:w-2/3 bg-gray-50 p-4 rounded">
      <div class="flex justify-between items-center mb-4">
        <h2 id="title-active" class="text-xl">Active Triangles</h2>
        <button id="locate" class="bg-primary text-white px-3 py-1 rounded">Locate Me</button>
      </div>
      <div id="map-wrap" class="w-full h-80 bg-gray-200 rounded overflow-hidden">
        <svg id="map"></svg>
      </div>
      <div class="mt-4 grid grid-cols-3 text-center gap-4">
        <div><p id="cnt-p" class="text-2xl">0</p><span id="lbl-p">Participants</span></div>
        <div><p id="cnt-t" class="text-2xl">0</p><span id="lbl-t">Triangles</span></div>
        <div><p id="cnt-w" class="text-2xl">0</p><span id="lbl-w">Waiting</span></div>
      </div>
      <button id="sim" class="mt-4 w-full bg-primary text-white py-2 rounded">Test Mode</button>
    </section>
    <!-- Form -->
    <aside class="w-full md:w-1/3 bg-gray-50 p-4 rounded">
      <div id="form">
        <input id="name" type="text" placeholder="Your Name" class="w-full mb-2 p-2 border rounded" />
        <select id="cont" class="w-full mb-2 p-2 border rounded"><option value="">-- Continent --</option></select>
        <select id="ctry" class="w-full mb-2 p-2 border rounded hidden"><option value="">-- Country --</option></select>
        <input id="city" list="cities" placeholder="City" class="w-full mb-2 p-2 border rounded hidden" />
        <datalist id="cities"></datalist>
        <button id="join" class="w-full bg-primary text-white py-2 rounded">Join</button>
      </div>
      <div id="status" class="hidden text-center">
        <p id="msg"></p><p id="info"></p><p id="stat"></p><p id="timer"></p>
        <button id="start" class="mt-2 bg-primary text-white py-2 rounded w-full">Start Meditation</button>
      </div>
    </aside>
  </main>
  <footer class="bg-gray-100 p-4 text-center text-sm">© 2025 Triangle Meditation Network</footer>
  <script>
    // Translations
    const tr={en:{Participants:'Participants',Triangles:'Triangles',Waiting:'Waiting',Active:'Active Triangles'},fr:{Participants:'Participants',Triangles:'Triangles',Waiting:'En attente',Active:'Triangles Actifs'}};
    let lang=navigator.language.slice(0,2); if(!tr[lang])lang='en';
    // Geo data
    const geo={continents:[{id:'europe',name:'Europe'},{id:'asia',name:'Asia'},{id:'africa',name:'Africa'}],countries:{europe:[{id:'fr',name:'France'},{id:'de',name:'Germany'}]},cities:{fr:['Paris','Lyon'],de:['Berlin','Munich']},coords:{fr:[46.2,2.2],de:[51.2,10.4]}};
    // App data
    const app={participants:[],triangles:[],user:null};
    // Init translation
    function setLang(l){lang=l;document.getElementById('lbl-p').textContent=tr[l].Participants;document.getElementById('lbl-t').textContent=tr[l].Triangles;document.getElementById('lbl-w').textContent=tr[l].Waiting;document.getElementById('title-active').textContent=tr[l].Active;}
    document.getElementById('lang').value=lang;document.getElementById('lang').onchange=e=>setLang(e.target.value);
    setLang(lang);
    // Populate continents
    geo.continents.forEach(c=>document.getElementById('cont').append(new Option(c.name,c.id)));
    document.getElementById('cont').onchange=function(){const sel=this.value;const cc=document.getElementById('ctry');cc.innerHTML='<option>-- Country --</option>';geo.countries[sel].forEach(o=>cc.append(new Option(o.name,o.id)));cc.classList.remove('hidden');};
    document.getElementById('ctry').onchange=function(){const c=this.value;const data=geo.cities[c]||[];const dl=document.getElementById('cities');dl.innerHTML='';data.forEach(v=>dl.append(new Option(v,v)));document.getElementById('city').classList.remove('hidden');};
    // Map init
    const svg=d3.select('#map'),wrap=document.getElementById('map-wrap');const w=wrap.clientWidth,h=wrap.clientHeight;
    svg.attr('width',w).attr('height',h);
    const proj=d3.geoNaturalEarth1().scale(w/6.28).translate([w/2,h/2]);const path=d3.geoPath().projection(proj);
    const mapL=svg.append('g'),triL=svg.append('g');
    d3.json('https://unpkg.com/world-atlas@2.0.2/countries-110m.json').then(d=>{const f=topojson.feature(d,d.objects.countries).features;mapL.selectAll('path').data(f).enter().append('path').attr('d',path).attr('fill','#ccc').attr('stroke','#333');});
    // Zoom
    svg.call(d3.zoom().scaleExtent([1,8]).on('zoom',e=>{mapL.attr('transform',e.transform);triL.attr('transform',e.transform);}));
    // Helpers
    function updateStats(){document.getElementById('cnt-p').textContent=app.participants.length;document.getElementById('cnt-t').textContent=app.triangles.length;document.getElementById('cnt-w').textContent=app.participants.length%3;}
    function form(){let arr=app.participants.slice();app.triangles=[];while(arr.length>=3){app.triangles.push({members:arr.splice(0,3),color:'#'+((1<<24)*Math.random()|0).toString(16)});}draw();}
    function draw(){triL.selectAll('*').remove();const pts=triL.append('g'),ln=triL.append('g');const members=app.participants;
      members.forEach(p=>{const xy=proj([p.coordinates[1],p.coordinates[0]]);pts.append('circle').attr('class','triangle-point'+(p===app.user?' user-point':'')) .attr('cx',xy[0]).attr('cy',xy[1]).attr('r',5).attr('fill',(p===app.user?'#E34A5F':'#5D5CDE'));});
      app.triangles.forEach(t=>{t.members.forEach((a,i)=>{const b=t.members[(i+1)%3];const p1=proj([a.coordinates[1],a.coordinates[0]]),p2=proj([b.coordinates[1],b.coordinates[0]]);ln.append('line').attr('class','triangle-path').attr('x1',p1[0]).attr('y1',p1[1]).attr('x2',p2[0]).attr('y2',p2[1]).attr('stroke',t.color).attr('stroke-width',1);} )});updateStats();}
    // Events
    document.getElementById('sim').onclick=()=>{app.participants=[];for(let i=0;i<30;i++){app.participants.push({coordinates:[(Math.random()*180)-90,(Math.random()*360)-180]});}form();};
    document.getElementById('join').onclick=()=>{const name=document.getElementById('name').value,c=document.getElementById('ctry').value,ci=document.getElementById('city').value; if(!name||!c||!ci) return alert('fill all'); const coords=geo.coords[c]||[0,0]; app.user={coordinates:coords};app.participants.push(app.user);form();};
  </script>
</body>
</html>
