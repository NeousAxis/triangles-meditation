<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Triangle Meditation Network</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { primary: '#5D5CDE' } } }
    };
  </script>
  <!-- D3, TopoJSON, Delaunay -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script src="https://unpkg.com/d3-delaunay@6"></script>
  <style>
    .triangle-path { stroke-dasharray: 10; animation: dash 3s linear infinite; }
    @keyframes dash { to { stroke-dashoffset: 30; } }
    .triangle-point { animation: pulse 2s infinite; transform-origin: center; }
    @keyframes pulse { 0%,100% { opacity: .7; transform: scale(.9); } 50% { opacity:1; transform: scale(1.2); } }
    .user-point { stroke: #fff; stroke-width: 2px; animation: userPulse 2s infinite; }
    @keyframes userPulse { 0%,100% { opacity: .8; transform: scale(1); } 50% { opacity:1; transform: scale(1.3); } }
  </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans min-h-screen flex flex-col">

<header class="bg-primary text-white p-4 shadow-md">
  <div class="container mx-auto flex justify-between items-center">
    <h1 id="app-title" class="text-2xl font-bold">Triangle Meditation Network</h1>
    <select id="lang" class="bg-white text-gray-800 p-1 rounded">
      <option value="en">English</option>
      <option value="fr">Français</option>
      <option value="es">Español</option>
      <option value="de">Deutsch</option>
      <option value="it">Italiano</option>
      <option value="ru">Русский</option>
      <option value="zh">中文</option>
      <option value="ar">العربية</option>
      <option value="hi">हिन्दी</option>
    </select>
  </div>
</header>

<main class="flex-grow container mx-auto p-4 flex flex-col md:flex-row gap-6">
  <!-- Map Panel -->
  <section class="w-full md:w-2/3 bg-gray-50 dark:bg-gray-800 p-4 rounded shadow">
    <div class="flex justify-between items-center mb-4">
      <h2 id="title-active" class="text-xl font-semibold">Active Triangles</h2>
      <button id="locate" class="bg-primary text-white px-3 py-1 rounded">Locate Me</button>
    </div>
    <div id="map-wrap" class="w-full h-80 bg-gray-200 dark:bg-gray-700 rounded overflow-hidden">
      <svg id="map" class="w-full h-full"></svg>
    </div>
    <div class="mt-4 grid grid-cols-3 gap-4 text-center">
      <div><p id="cnt-p" class="text-2xl">0</p><span id="lbl-p">Participants</span></div>
      <div><p id="cnt-t" class="text-2xl">0</p><span id="lbl-t">Triangles</span></div>
      <div><p id="cnt-w" class="text-2xl">0</p><span id="lbl-w">Waiting</span></div>
    </div>
    <button id="sim" class="mt-4 w-full bg-primary text-white py-2 rounded">Test Mode</button>
  </section>

  <!-- Registration Panel -->
  <aside class="w-full md:w-1/3 bg-gray-50 dark:bg-gray-800 p-4 rounded shadow">
    <div id="form">
      <input id="name" type="text" placeholder="Your Name" class="w-full mb-2 p-2 border rounded" />
      <select id="cont" class="w-full mb-2 p-2 border rounded">
        <option value="">-- Continent --</option>
      </select>
      <select id="ctry" class="w-full mb-2 p-2 border rounded hidden">
        <option value="">-- Country --</option>
      </select>
      <input id="city" list="cities" placeholder="City" class="w-full mb-2 p-2 border rounded hidden" />
      <datalist id="cities"></datalist>
      <button id="join" class="w-full bg-primary text-white py-2 rounded">Join</button>
    </div>
    <div id="status" class="hidden text-center mt-4">
      <p id="msg" class="mb-2"></p>
      <p id="info" class="mb-2"></p>
      <p id="stat" class="mb-2"></p>
      <p id="timer" class="mb-2"></p>
      <button id="start" class="w-full bg-primary text-white py-2 rounded mb-2">Start Meditation</button>
      <button id="leave" class="w-full bg-red-500 text-white py-2 rounded">Leave Network</button>
    </div>
  </aside>
</main>

<footer class="bg-gray-100 dark:bg-gray-800 p-4 text-center text-sm">© 2025 Triangle Meditation Network</footer>

<script>
// Translations
const tr = {
  en: { Participants:'Participants', Triangles:'Triangles', Waiting:'Waiting', Active:'Active Triangles', 'Your Name':'Your Name', 'Locate Me':'Locate Me', 'Test Mode':'Test Mode', Join:'Join', 'Start Meditation':'Start Meditation', 'Leave Network':'Leave Network' },
  fr: { Participants:'Participants Actuels', Triangles:'Triangles Formés', Waiting:'Participants en Attente', Active:'Triangles Actifs', 'Your Name':'Votre Nom', 'Locate Me':'Géolocaliser', 'Test Mode':'Mode Test', Join:'Rejoindre le Réseau', 'Start Meditation':'Commencer la Méditation', 'Leave Network':'Quitter le Réseau' }
};
let lang = (navigator.language||'en').slice(0,2);
if(!tr[lang]) lang='en';
// GeoData
const geo = {
  continents: [ {id:'europe',name:'Europe'},{id:'asia',name:'Asia'},{id:'africa',name:'Africa'},{id:'north-america',name:'North America'},{id:'south-america',name:'South America'},{id:'oceania',name:'Oceania'} ],
  countries:{ europe:[{id:'fr',name:'France'},{id:'de',name:'Germany'},{id:'it',name:'Italy'},{id:'es',name:'Spain'}], asia:[{id:'cn',name:'China'},{id:'jp',name:'Japan'}], africa:[{id:'eg',name:'Egypt'}], 'north-america':[{id:'us',name:'United States'}], 'south-america':[{id:'br',name:'Brazil'}], oceania:[{id:'au',name:'Australia'}] },
  cities:{ fr:['Paris','Lyon'], de:['Berlin','Munich'], it:['Rome','Milan'], es:['Madrid','Barcelona'], us:['New York','Los Angeles'], cn:['Beijing','Shanghai'], br:['São Paulo','Rio de Janeiro'], au:['Sydney','Melbourne'] },
  coords:{ fr:[46.2,2.2], de:[51.2,10.4], it:[41.9,12.5], es:[40.4,-3.7], us:[40.7,-74.0], cn:[39.9,116.4], br:[-23.5,-46.6], au:[-33.9,151.2] }
};
// App state
const app={ participants:[], triangles:[], user:null };
// Translation helper
function applyLang(){
  document.getElementById('lbl-p').textContent = tr[lang].Participants;
  document.getElementById('lbl-t').textContent = tr[lang].Triangles;
  document.getElementById('lbl-w').textContent = tr[lang].Waiting;
  document.getElementById('title-active').textContent = tr[lang].Active;
  document.getElementById('locate').textContent = tr[lang]['Locate Me'];
  document.getElementById('sim').textContent = tr[lang]['Test Mode'];
  document.getElementById('join').textContent = tr[lang].Join;
  document.getElementById('start').textContent = tr[lang]['Start Meditation'];
  document.getElementById('leave').textContent = tr[lang]['Leave Network'];
}
// Initialize language selector
const selLang = document.getElementById('lang'); selLang.value=lang;
selLang.onchange = e=>{ lang=e.target.value; applyLang(); };
applyLang();
// Geo selectors
const selCont = document.getElementById('cont'), selCtry = document.getElementById('ctry'), inpCity=document.getElementById('city'), dlCities=document.getElementById('cities');
geo.continents.forEach(c=> selCont.append(new Option(c.name,c.id)));
selCont.onchange = ()=>{
  selCtry.innerHTML='<option value="">-- Country --</option>';
  geo.countries[selCont.value]?.forEach(c=> selCtry.append(new Option(c.name,c.id)));
  selCtry.classList.remove('hidden'); inpCity.classList.add('hidden');
};
selCtry.onchange = ()=>{
  dlCities.innerHTML=''; geo.cities[selCtry.value]?.forEach(city=> dlCities.append(new Option(city,city)));
  inpCity.classList.remove('hidden');
};
// D3 Map init
const svg = d3.select('#map'), wrap = document.getElementById('map-wrap'); const w = wrap.clientWidth, h = wrap.clientHeight;
svg.attr('width',w).attr('height',h);
const projection = d3.geoNaturalEarth1().scale(w/6.28).translate([w/2,h/2]);
const path = d3.geoPath().projection(projection);
const mapL = svg.append('g'), triL = svg.append('g');
d3.json('https://unpkg.com/world-atlas@2.0.2/countries-110m.json').then(world=>{
  mapL.selectAll('path').data(topojson.feature(world,world.objects.countries).features)
    .enter().append('path').attr('d',path).attr('fill','#888').attr('stroke','#555');
});
svg.call(d3.zoom().scaleExtent([1,8]).on('zoom',e=>{mapL.attr('transform',e.transform);triL.attr('transform',e.transform);}));
// Stats update
function updateStats(){ document.getElementById('cnt-p').textContent=app.participants.length; document.getElementById('cnt-t').textContent=app.triangles.length; document.getElementById('cnt-w').textContent=app.participants.length%3; }
function formTriangles(){ let arr=[...app.participants]; app.triangles=[]; while(arr.length>=3){ app.triangles.push({ members:arr.splice(0,3), color:'#'+((1<<24)*Math.random()|0).toString(16) }); } drawTriangles(); }
function drawTriangles(){ triL.selectAll('*').remove(); const pts=triL.append('g'), ln=triL.append('g');
  app.participants.forEach(p=>{ const [x,y]=projection([p.coordinates[1],p.coordinates[0]]); pts.append('circle').attr('class','triangle-point'+(p===app.user?' user-point':'')) .attr('cx',x).attr('cy',y).attr('r',5).attr('fill',p===app.user?'#E34A5F':'#5D5CDE'); });
  app.triangles.forEach(t=>{ t.members.forEach((a,i)=>{ const b=t.members[(i+1)%3]; const p1=projection([a.coordinates[1],a.coordinates[0]]), p2=projection([b.coordinates[1],b.coordinates[0]]); ln.append('line').attr('class','triangle-path').attr('x1',p1[0]).attr('y1',p1[1]).attr('x2',p2[0]).attr('y2',p2[1]).attr('stroke',t.color).attr('stroke-width',1); }); });
  updateStats(); }
// Events
document.getElementById('sim').onclick = ()=>{ app.participants=[]; for(let i=0;i<30;i++) app.participants.push({ coordinates:[Math.random()*180-90,Math.random()*360-180] }); formTriangles(); };
document.getElementById('join').onclick = ()=>{ const c=selCtry.value, city=inpCity.value; if(!document.getElementById('name').value||!selCont.value||!c||!city) { alert('Fill all'); return; } const coords=geo.coords[c]||[0,0]; app.user={coordinates:coords}; app.participants.push(app.user); formTriangles(); document.getElementById('form').classList.add('hidden'); document.getElementById('status').classList.remove('hidden'); document.getElementById('msg').textContent = tr[lang].Join+' '+document.getElementById('name').value; };
</script>
</body>
</html>
