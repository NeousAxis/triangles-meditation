<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>M√©ditation en triangle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  />

  <!-- Firebase SDKs (compat version via <script>) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; position:absolute; top:0; left:0; }
    #controls {
      position:absolute; top:1rem; right:1rem; z-index:1000;
      background:rgba(255,255,255,0.9); padding:1rem;
      border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.3);
      font-family:sans-serif; display:flex; flex-direction:column; gap:0.5rem;
    }
    .group-list { display:flex; flex-wrap:wrap; gap:0.3rem; margin-bottom:0.5rem; }
    .group-list button,
    #controls button,
    #controls select { padding:0.4rem 0.8rem; font-size:0.9rem; }
    #controls label { display:flex; align-items:center; gap:0.5rem; }
  </style>
</head>
<body>
  <!-- Carte -->
  <div id="map"></div>

  <!-- Contr√¥les -->
  <div id="controls">
    <span id="lbl-triangle">Triangle :</span>
    <div id="groupList" class="group-list"></div>
    <button id="newBtn">Nouveau</button>
    <button id="addBtn">Je m√©dite !</button>
    <button id="simulateBtn">Simuler</button>
    <label>
      <span id="lbl-lang">Langue :</span>
      <select id="langSelect"></select>
    </label>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // üöÄ 1) Colle ta config Firebase (compat) ici :
    const firebaseConfig = {
      apiKey: "AIzaSyBaMcVHdo2yWYCO0K19iLQkWg1W3_zxy_8",
      authDomain: "triangles-meditation.firebaseapp.com",
      projectId: "triangles-meditation",
      storageBucket: "triangles-meditation.appspot.com",
      messagingSenderId: "501789370541",
      appId: "1:501789370541:web:11dd620095e401503a7e24",
      measurementId: "G-QPWKZZN6T1"
    };

    // üöÄ 2) Initialise Firebase + Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // üé® Initialise Leaflet
    const map = L.map('map').setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'¬© OpenStreetMap contributors'
    }).addTo(map);
    delete L.Icon.Default.prototype._getIconUrl;
    L.Icon.Default.mergeOptions({
      iconRetinaUrl:'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png',
      iconUrl:'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
      shadowUrl:'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png'
    });

    // üí° √âtat de l‚Äôapp & i18n
    let markers = [], selected = '', lang = 'fr';
    const i18n = {
      fr: { triangle:'Triangle', add:'Je m√©dite !', simulate:'Simuler', new:'Nouveau', lang:'Langue', popup:'Triangle', alertAdd:'Point ajout√© : ' },
      en: { triangle:'Triangle', add:'I meditate!', simulate:'Simulate', new:'New', lang:'Language', popup:'Triangle', alertAdd:'Added point: ' }
    };

    // R√©f√©rences DOM
    const groupList = document.getElementById('groupList');
    const newBtn     = document.getElementById('newBtn');
    const addBtn     = document.getElementById('addBtn');
    const simBtn     = document.getElementById('simulateBtn');
    const langSelect = document.getElementById('langSelect');
    const lblTriangle= document.getElementById('lbl-triangle');
    const lblLang    = document.getElementById('lbl-lang');

    // Traduire l‚ÄôUI
    function translateUI() {
      lblTriangle.textContent = i18n[lang].triangle + ' :';
      newBtn.textContent      = i18n[lang].new;
      addBtn.textContent      = i18n[lang].add;
      simBtn.textContent      = i18n[lang].simulate;
      lblLang.textContent     = i18n[lang].lang + ' :';
    }

    // Afficher les groupes
    function renderGroups() {
      groupList.innerHTML = '';
      // Bouton Nouveau
      newBtn.onclick = () => { selected=''; renderGroups(); renderMarkers(); };
      // Comptabiliser les triangles
      const counts = markers.reduce((acc,m) => {
        acc[m.triangle_id] = (acc[m.triangle_id]||0)+1;
        return acc;
      }, {});
      Object.entries(counts).forEach(([id,c]) => {
        const btn = document.createElement('button');
        btn.textContent = `${id} (${c})`;
        btn.onclick = () => { selected=id; renderGroups(); renderMarkers(); };
        if(id===selected) btn.style.background='#ddd';
        groupList.appendChild(btn);
      });
    }

    // Afficher les marqueurs
    function renderMarkers() {
      map.eachLayer(l => { if(l.options.pane==='markerPane') map.removeLayer(l); });
      markers.forEach(m => {
        const isSel = m.triangle_id===selected;
        const mk = isSel
          ? L.circleMarker([m.lat,m.lng], { radius:8, color:'#f00', fillOpacity:0.6 })
          : L.marker([m.lat,m.lng]);
        mk.bindPopup((isSel?'‚ñ∂ ':'') + i18n[lang].popup + m.triangle_id);
        mk.addTo(map);
      });
    }

    // üî¥ √âcouter Firestore en temps r√©el
    db.collection('markers')
      .orderBy('created_at')
      .onSnapshot(snap => {
        markers = snap.docs.map(d => d.data());
        translateUI(); renderGroups(); renderMarkers();
      });

    // ‚ûï Ajouter un point (Je m√©dite !)
    addBtn.onclick = () => navigator.geolocation.getCurrentPosition(({coords}) => {
      const tri = selected || crypto.randomUUID().slice(0,8);
      db.collection('markers').add({
        triangle_id: tri,
        lat: coords.latitude,
        lng: coords.longitude,
        created_at: Date.now()
      });
      alert(i18n[lang].alertAdd + tri);
    });

    // üîÑ Simuler
    simBtn.onclick = async () => {
      // Supprimer l‚Äôexistant
      const batch = db.batch();
      const snap   = await db.collection('markers').get();
      snap.docs.forEach(d => batch.delete(d.ref));
      await batch.commit();
      // Cr√©er 10 triangles
      for(let t=0; t<10; t++){
        const id  = crypto.randomUUID().slice(0,6);
        const lat0 = Math.random()*180-90, lng0 = Math.random()*360-180;
        for(let i=0; i<3; i++){
          db.collection('markers').add({
            triangle_id: id,
            lat: lat0 + (Math.random()-0.5)*5,
            lng: lng0 + (Math.random()-0.5)*5,
            created_at: Date.now()
          });
        }
      }
    };

    // Changer de langue
    Object.keys(i18n).forEach(code => {
      const opt = document.createElement('option');
      opt.value   = code;
      opt.textContent = code.toUpperCase();
      langSelect.appendChild(opt);
    });
    langSelect.onchange = e => { lang=e.target.value; translateUI(); renderGroups(); renderMarkers(); };

    // Initialisation
    translateUI();
  });
  </script>
</body>
</html>
