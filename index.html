<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triangle Meditation Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://unpkg.com/marked@4.0.0/marked.min.js"></script>
    <style>
        .triangle-path { stroke-dasharray: 10; stroke-dashoffset: 0; animation: dash 3s linear infinite; }
        @keyframes dash { from { stroke-dashoffset: 0; } to { stroke-dashoffset: 30; } }
        .triangle-point { animation: pulse 2s infinite; transform-origin: center center; transform-box: fill-box; }
        @keyframes pulse { 0% { opacity: 0.7; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0.7; transform: scale(0.9); } }
        .user-point { stroke: white; stroke-width: 2px; animation: userPulse 2s infinite; }
        @keyframes userPulse { 0% { opacity: 0.8; stroke-width: 2px; transform: scale(1); } 50% { opacity: 1; stroke-width: 3px; transform: scale(1.3); } 100% { opacity: 0.8; stroke-width: 2px; transform: scale(1); } }
        .map-container { touch-action: manipulation; }
        /* Dark mode and spinner unchanged */
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { primary: '#5D5CDE' } } } };
    </script>
</head>
<body class="font-sans min-h-screen flex flex-col bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <!-- Language & theme detection -->
    <script> /* unchanged original detection code */ </script>

    <header class="bg-primary text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 id="app-title" class="text-2xl font-bold"></h1>
            <select id="language-selector" class="bg-white text-gray-800 rounded px-3 py-1">
                <option value="en">English</option>
                <option value="fr">Français</option>
                <option value="es">Español</option>
                <option value="de">Deutsch</option>
                <option value="it">Italiano</option>
                <option value="ru">Русский</option>
            </select>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 flex flex-col md:flex-row gap-6">
        <!-- Map panel unchanged -->
        <div class="w-full md:w-2/3 map-container bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md overflow-hidden">
            <!-- content unchanged -->
        </div>

        <!-- Registration & status -->
        <div class="w-full md:w-1/3 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
            <div id="registration-form" class="flex flex-col gap-4">
                <!-- original form fields unchanged -->
                <button id="join-network" class="w-full btn-primary">Join Network</button>
            </div>
            <div id="status-panel" class="hidden flex flex-col gap-4">
                <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <h3 id="status-title" class="font-semibold text-center mb-2"></h3>
                    <p id="status-message" class="text-center mb-4"></p>
                    <p id="participant-info"></p>
                    <p id="triangle-status"></p>
                    <p id="time-remaining" class="mt-4 text-primary"></p>
                    <div id="position-timer" class="text-sm text-gray-500"></div>
                    <div id="meditation-timer-container" class="hidden mt-4 text-center">
                        <div id="meditation-timer" class="text-4xl font-bold">20:00</div>
                    </div>
                    <button id="leave-network" class="w-full mt-4 bg-red-500 text-white rounded py-2">Leave Network</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-100 dark:bg-gray-800 p-4 text-center text-gray-600 dark:text-gray-400">© 2025 Triangle Meditation Network</footer>

    <script>
    // -- Preserve all original appData, translations, geoData, mapState, simulation code unchanged --

    document.addEventListener('DOMContentLoaded', () => {
        updateLanguage(appData.currentLanguage);
        document.getElementById('language-selector').value = appData.currentLanguage;
        document.getElementById('language-selector').addEventListener('change', e => updateLanguage(e.target.value));
        initializeMap(); initializeGeoSelectors(); setInterval(updateTriangles,3000);
        document.getElementById('join-network').addEventListener('click', joinNetwork);
        document.getElementById('leave-network').addEventListener('click', leaveNetwork);
        loadUserData(); checkSimulationStatus();
    });

    async function joinNetwork() {
        // original validation & loading spinner code
        const coords = await getCityCoordinates(...); // keep original
        appData.userProfile = { /* same fields but expiresAt = now+20min */ };
        localStorage.setItem('userProfile', JSON.stringify(appData.userProfile));
        appData.participants.push(appData.userProfile);
        formTriangles();
        showStatusPanel();
        startPositionTimer();
        autoStartMeditationIfInTriangle();
    }

    function autoStartMeditationIfInTriangle() {
        const tri = findUserTriangle();
        if (tri) {
            showMeditationTimer();
            startMeditation();
        }
    }

    function startPositionTimer() {
        let t = Math.round((appData.userProfile.expiresAt - Date.now())/1000);
        const el = document.getElementById('position-timer');
        const iv = setInterval(() => {
            t--; if (t<=0) return resetUser();
            el.textContent = formatTime(t);
        },1000);
    }

    function startMeditation() {
        let t = Math.round((appData.userProfile.expiresAt - Date.now())/1000);
        const el = document.getElementById('meditation-timer');
        showMeditationTimer();
        const iv = setInterval(() => {
            t--; if (t<=0) { clearInterval(iv); document.getElementById('triangle-status').textContent='Meditation complete'; return; }
            el.textContent = formatTime(t);
        },1000);
    }

    function formatTime(sec) { const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

    function resetUser() {
        localStorage.removeItem('userProfile'); window.appData.userProfile=null;
        appData.participants = appData.participants.filter(p=> !p.id.startsWith('user-'));
        hideStatusPanel(); showRegistrationForm(); formTriangles();
    }

    // All other original functions (leaveNetwork, loadUserData, initializeMap, formTriangles, translations, simulation) stay unchanged.

    </script>
</body>
</html>
