<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Connect globally in meditation triangles with real-time mapping and community features.">
  <title>Triangle Meditation Network</title>
  <link rel="icon" href="/favicon.ico" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { primary: '#5D5CDE' } } } };
  </script>
  <!-- D3, TopoJSON & D3-Delaunay -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script src="https://unpkg.com/d3-delaunay@6"></script>
  <script src="https://d3js.org/d3-zoom.v2.min.js"></script>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="font-sans min-h-screen flex flex-col bg-white text-gray-800">
  <header class="bg-primary text-white p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold" id="app-title">Triangle Meditation Network</h1>
      <select id="language-selector" class="bg-white text-gray-800 rounded px-3 py-1 text-base">
        <option value="en">English</option>
        <option value="fr">Français</option>
        <option value="es">Español</option>
        <option value="de">Deutsch</option>
        <option value="it">Italiano</option>
        <option value="ru">Русский</option>
      </select>
    </div>
  </header>

  <main class="flex-grow container mx-auto p-4 flex flex-col md:flex-row gap-6">
    <!-- Map & Stats -->
    <section class="w-full md:w-2/3 bg-white p-4 rounded-lg shadow-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold" id="active-triangles-title">Active Triangles</h2>
        <button id="geolocate-button" class="bg-primary text-white px-3 py-1 rounded text-sm">Use My Location</button>
      </div>
      <div id="map-container" class="w-full h-80 md:h-96 relative bg-gray-100"><svg id="map" class="w-full h-full"></svg></div>
      <div class="mt-4 grid grid-cols-3 gap-4 text-center">
        <div class="bg-gray-100 p-2 rounded"><h3 class="font-semibold" id="participants-label">Participants</h3><p id="participants-count" class="text-xl">0</p></div>
        <div class="bg-gray-100 p-2 rounded"><h3 class="font-semibold" id="triangles-label">Triangles</h3><p id="triangles-count" class="text-xl">0</p></div>
        <div class="bg-gray-100 p-2 rounded"><h3 class="font-semibold" id="waiting-label">Waiting</h3><p id="waiting-count" class="text-xl">0</p></div>
      </div>
      <button id="simulation-button" class="mt-4 w-full bg-primary text-white py-2 rounded">Start Test Mode</button>
    </section>

    <!-- Registration & Status -->
    <aside class="w-full md:w-1/3 bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold text-center" id="welcome-text">Join the Network</h2>
      <form id="registration-form" class="space-y-4">
        <div>
          <label for="user-name" id="user-name-label" class="block mb-1">Your Name</label>
          <input type="text" id="user-name" class="w-full p-2 border rounded" required>
        </div>
        <div>
          <label for="user-continent" id="continent-label" class="block mb-1">Continent</label>
          <select id="user-continent" class="w-full p-2 border rounded">
            <option value="">-- Select --</option>
            <option>Africa</option>
            <option>Asia</option>
            <option>Europe</option>
            <option>North America</option>
            <option>South America</option>
            <option>Oceania</option>
          </select>
        </div>
        <div>
          <label for="user-country" id="country-label" class="block mb-1">Country</label>
          <select id="user-country" class="w-full p-2 border rounded"><option value="">-- Select --</option></select>
        </div>
        <div>
          <label for="user-city" id="city-label" class="block mb-1">City</label>
          <input type="text" id="user-city" class="w-full p-2 border rounded">
        </div>
        <button type="submit" id="join-network" class="w-full bg-primary text-white py-2 rounded">Join</button>
      </form>
      <div id="status-panel" class="hidden text-center space-y-4">
        <h3 id="status-title" class="text-lg font-semibold">Network Status</h3>
        <p id="status-message"></p>
        <button id="leave-network" class="w-full bg-red-500 text-white py-2 rounded">Leave Network</button>
      </div>
    </aside>
  </main>

  <footer class="bg-gray-100 p-4 text-center text-sm text-gray-600">
    <p>© 2025 Triangle Meditation Network · <a href="https://github.com/your-username/triangles-meditation" class="text-primary hover:underline" target="_blank">GitHub</a></p>
  </footer>

  <script>
    // Translations including Italian & Russian
    const dict = {
      en:{ 'Join the Network':'Join the Network','Your Name':'Your Name','Continent':'Continent','Country':'Country','City':'City','Join':'Join','Use My Location':'Use My Location','Start Test Mode':'Start Test Mode' },
      fr:{ 'Join the Network':'Rejoignez le réseau','Your Name':'Votre nom','Continent':'Continent','Country':'Pays','City':'Ville','Join':'Rejoindre','Use My Location':'Géolocaliser','Start Test Mode':'Mode Test' },
      es:{ 'Join the Network':'Únete a la red','Your Name':'Tu nombre','Continent':'Continente','Country':'País','City':'Ciudad','Join':'Unirse','Use My Location':'Usar ubicación','Start Test Mode':'Modo Prueba' },
      de:{ 'Join the Network':'Netzwerk beitreten','Your Name':'Dein Name','Continent':'Kontinent','Country':'Land','City':'Stadt','Join':'Beitreten','Use My Location':'Ort nutzen','Start Test Mode':'Testmodus' },
      it:{ 'Join the Network':'Entra nella rete','Your Name':'Il tuo nome','Continent':'Continente','Country':'Paese','City':'Città','Join':'Entra','Use My Location':'Usa posizione','Start Test Mode':'Modalità Test' },
      ru:{ 'Join the Network':'Присоединиться к сети','Your Name':'Ваше имя','Continent':'Континент','Country':'Страна','City':'Город','Join':'Присоединиться','Use My Location':'Моё местоположение','Start Test Mode':'Тестовый режим' }
    };
    function setLang(l){
      document.getElementById('language-selector').value=l;
      Object.keys(dict[l]).forEach(txt=>{
        document.querySelectorAll('label,button,option,h2,h3').forEach(el=>{
          if(el.textContent.trim()===txt) el.textContent=dict[l][txt];
        });
      });
      localStorage.setItem('lang',l);
    }
    document.addEventListener('DOMContentLoaded',()=>{
      // Language
      const sel=document.getElementById('language-selector'); const lang=localStorage.getItem('lang')||'en'; setLang(lang);
      sel.addEventListener('change',e=>setLang(e.target.value));

      // Countries list from topojson
      let countries=[];
      d3.json('https://unpkg.com/world-atlas@2.0.2/world/110m.json').then(t=>{
        const feats=topojson.feature(t,t.objects.countries).features;
        countries=feats.map(f=>f.properties.name).sort();
        const countrySel=document.getElementById('user-country');
        countries.forEach(c=> countrySel.appendChild(new Option(c,c)));
      });

      // Geolocation & Map
      const svg = d3.select('#map');
      const proj = d3.geoNaturalEarth1()
        .scale(150)
        .translate([svg.node().clientWidth/2, svg.node().clientHeight/2]);
      const path = d3.geoPath().projection(proj);
      const zoom = d3.zoom()
        .scaleExtent([1, 8])
        .on('zoom', (event) => {
          svg.selectAll('g').attr('transform', event.transform);
        });
      svg.call(zoom);
      // draw base map
      d3.json('https://unpkg.com/world-atlas@2.0.2/world/110m.json').then(t => {
        svg.append('g').selectAll('path')
          .data(topojson.feature(t, t.objects.countries).features)
          .enter().append('path')
            .attr('d', path)
            .attr('fill', '#eee')
            .attr('stroke', '#999');
      });
      document.getElementById('geolocate-button').addEventListener('click', () =>
        navigator.geolocation.getCurrentPosition(
          p => {
            const coords = [p.coords.latitude, p.coords.longitude];
            const [x, y] = proj([coords[1], coords[0]]);
            svg.transition().duration(750)
               .call(zoom.transform, d3.zoomIdentity
                 .translate(svg.node().clientWidth/2 - x, svg.node().clientHeight/2 - y)
                 .scale(4)
               );
          },
          () => alert('Permission denied')
        )
      );
      const svg=d3.select('#map'); const proj=d3.geoNaturalEarth1().scale(150).translate([svg.node().clientWidth/2,svg.node().clientHeight/2]); const path=d3.geoPath().projection(proj);
      d3.json('https://unpkg.com/world-atlas@2.0.2/world/110m.json').then(t=>{
        svg.append('g').selectAll('path').data(topojson.feature(t,t.objects.countries).features).enter().append('path').attr('d',path).attr('fill','#eee').attr('stroke','#999');
      });
      document.getElementById('geolocate-button').addEventListener('click',()=>navigator.geolocation.getCurrentPosition(p=>{
        const [lat,lon]=[p.coords.latitude,p.coords.longitude]; const [x,y]=proj([lon,lat]); svg.transition().duration(750).call(d3.zoom().transform,d3.zoomIdentity.translate(svg.node().clientWidth/2-x,svg.node().clientHeight/2-y).scale(2));
      },()=>alert('Permission denied')));

      // Registration
      document.getElementById('registration-form').addEventListener('submit',e=>{ e.preventDefault(); const name=e.target['user-name'].value; document.getElementById('status-message').textContent=`Welcome ${name}!`; document.getElementById('registration-form').classList.add('hidden'); document.getElementById('status-panel').classList.remove('hidden'); });

      // Simulation with triangles
      document.getElementById('simulation-button').addEventListener('click',()=>{
        svg.selectAll('.sim').remove();
        const points=d3.range(30).map(()=>[(Math.random()*180)-90,(Math.random()*360)-180]);
        const projected=points.map(d=>proj([d[1],d[0]]));
        const delaunay=d3.Delaunay.from(projected);
        const tris=delaunay.triangles;
        for(let i=0;i<tris.length;i+=3){ const [a,b,c]=[tris[i],tris[i+1],tris[i+2]];
          svg.append('path').attr('class','sim').attr('d',`M${projected[a]}L${projected[b]}L${projected[c]}Z`).attr('fill','none').attr('stroke','#5D5CDE').attr('stroke-width',1);
        }
        svg.selectAll('.sim-point').data(projected).enter().append('circle').attr('class','sim').attr('cx',d=>d[0]).attr('cy',d=>d[1]).attr('r',3).attr('fill','#5D5CDE');
        document.getElementById('participants-count').textContent=30;
        document.getElementById('triangles-count').textContent=(tris.length/3);
      });
    });
  </script>
</body>
</html>
